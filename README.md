# Stock Price By Financials:  Создание модели для определения стоимости акции на основе финансовых показателей компании

## Введение

### Цель и основная идея работы

На рынке ценных бумаг часто можно заметить акции, цена которых значительно изменяется в течении непродолжительного временного промежутка, обычно это связано с объективными и значительными изменениями в бизнесе компании, тем не менее не редки случаи когда акция компании получает чрезмерную или недостаточную популярность, вовремя замеченные такие акции являются идеальным вложением с перспективой на время, когда другие инвесторы так же заметят несправедливую цену акции. Поиск именно таких (недооцененных или же переоцененных) акций с помощью моделей машинного обучения является основной целью данной работы. В конце работы лучшие модели составят инвестиционный список на 2024 год.

### Тестирование моделей
Тестирование и подбор лучших моделей будет проходить в способ "псевдо" инвестирования в акции (на срок в 1 год), цена которых модель посчитала необъективной, после чего программа учтёт изменение цен акций на следующий год и получит годовой доход этой модели.

### Тонкости реализации

   В реализации проекта есть несколько неоднозначных моментов которые следует учитывать.

1. Идея обучении модели состоит в сопоставлении финансовых показателей компании с ценой ее акции, таким образом в лучшем случае модель в состоянии найти акцию, цена которой значительно отличается от других акций, при этом имея схожее с ними финансовое положение. Таким образом модель не в состоянии показать степень перегретости рынка и принимает цены акций на рынке как объективный показатель, пытаясь найти акции цена которых выделяется.
   
2. К большому сожалению сайт finance.yahoo предоставляет только 4 последних финансовых отчетностей, в связи с этим в проекте точность модели определяется только по краткосрочным инвестициям (1 год).  
   
3. Данные в проекте актуальны только на 2024 год, в последующем стоит обновить данные и возможно определить новые наилучшие модели.

## Выполнение проекта

### Сбор данных

1. Для обучения и тестирования моделей нужно получить доступ к ценам и финансовым отчетностям компаний. Для этого был использован сервис finance.yahoo, а также библиотека YFinance. Для начала стоило определить какие именно компании стоит использовать для обучения, для этого на сайте macrotrends были спарсены тикеры всех действующих компаний а также секторы их деятельности(All_lists).(data_collect.py)

2. После получения списков секторов с тикерами соответствующих компаний, используя yfinance были сформированны новые базы данных для фин. отчетностей компаний (All_lists_collected). Так же во время сбора данных компаний были написаны несколько функций для отсеивания нерелевантных данных.(main.py)

### Обучение моделей

Для выполнения этого проекта были выбраны 7 алгоритмов машинного обучения: **BayesianRidge**, **ElasticNet**, **Random Forest**, **XgBoosting**, **Gradient Boosting**, **CatBoosting**,  **Neural Network**, для большей ефективности обучения была использована optuna для подбора наилучших гиперпараметров(изменяемые параметры обучения для достижения наилучших результатов) моделей, ефективность модели определяется процентной разницей между предсказанной и фактической ценой акции. (train_models.py)

### Предварительная обработка данных

Во время предварительной обработки данных у нас имеется набор из множества различных элементов финансовой отчетности, для обучения модели требуется одинаковая размерность данных, для этого нужно удалить те компании и отчетности в данных которых много пробелов, оставшиеся отсутствующие данные нужно заполнить 'медианой значений из выборки основанной на цене компании' (среднее значение пробела (Например "Рабочий капитал") исходя из данных других компаний со схожей ценой акции), для 1 задачи были использованы 2 коэффициента (гиперпараметры optuna) которые отвечали за допустимое количество пропусков в елементах фин. отчетности и количества пропущеных елементов самих отчетностей, для поиска медиан данных и заполнения оставшихся пропусков была использована линейная регрессия. (preprocessing.py)

На данном этапе количество елементов фин. отчетности (входных данных) обычно составляет около 200 единиц, использования их всех для обучения модели может быть нежелательным из за количества итераций необходимых для обучения модели, и как следствие переобучение модели из за относительно небольшого количества самих отчетностей во многих секторах, а так же из за большого количества необходимых вычислительных ресурсов и времени для обучения. Для уменьшения количества входных данных использовав корреляцию между елементами фин. отчетностей и ценой акции (отсортировав результаты по моделю) был осуществлен поиск наиболее подходящих елементов для обучения, количество елементов наиболее коррелирующих данных определяется гиперпараметром nlarge.

Наконец, можно приступать к обучению самих моделей и подбору наилучших гиперпараметров. После определения лучших параметров моделей, модели будут использованы для псевдо инвестирования и на основе результатов для них будут подобраны лучшие параметры инвестирования.

### Псевдо инвестирование

Суть псевдо инвестирования состоит в том что бы в определенном секторе модель предсказала цены всех компаний и если их действующая цена меньше предсказанной на определенный процент (гиперпараметр price_discount) то скрипт якобы покупает n количество акций, после чего сравнивает цену покупки с ценой на следующий год и получает результат инвестирования (прибыль или убыток) в зависимости от направления инвестирования (long или short позиция) и точности предсказания. (estimate_func.py)

После того как подобраны лучшие гиперпараметры для псевдо инвестирования (процент скидки, направление инвестирования) скрипт записывает лучшие модели, а также их гиперпараметры в файл. 

Также для большей достоверности результатов скрипт запускается еще раз только с данными за предпоследний год. В результате у нас есть лучшие параметры моделей а также 2 годовых инвестиционных отчета от всевдо инвестиций. На основе всех полученных данных была составлена таблица.

##  Итоги
На данном этапе работа выполнена и пора подводить итоги:
### Таблица итогов

Заполненая таблица с результатами всех моделей находится в файле **Models_Results.xlsx**.
Стоит отдельно отметить 7 наилучших моделей
![Top7](https://github.com/Kertn/Stock_Price_by_Financials/assets/111581848/966c5ecc-c2d1-4fa1-b20d-e7273af68278)

1 колона - Сектор инвестиций\
2 колона - Модель\
3 колона - Годовой доход модели\
4 колона - Количество купленных акций различных компаний\
5 колона - Количество доступных акций различных компаний\
6 колона - Годовой доход модели (Предпоследний год)\
7 колона - Количество купленных акций различных компаний(Предпоследний год)\
8 колона - Количество доступных акций различных компаний(Предпоследний год)\
9 колона - Процентная разница между предсказанной ценой акции и фактической (100% - min)\
10 колона - Направление инвестиций\
11 колона - Необходимая скидка для покупки акции\
12 колона - Параметры модели

### Инвестирование

Что касается использование 7 лучших моделей для инвестиций в 2024 году (Invest), то лучше всего себя показывает (Medical Multi-Sector Conglomerates, CatBoost) на момент 19.04.2024 доход модели составляет 36.8%\
Далее с 1% доходностью идет (Full_list, Random_Forest)\
Хуже всего показатели у (Transportation, Neural Network) - 26.2%\
В целом на данный момент 5 из 7 моделей имеют убыточность от -11% до -26%.

### Выводы
**В связи с количеством неудачных инвестиций с начала 2024 года на данный момент стоит скептически относиться к применению моделей для покупки акций, как минимум стоит узнать их доходность в предстоящем 2024, а лучше и в 2025 году. Тем не менее предсказания моделей хорошо подходят для дополнительного ручного анализа наиболее недооцененных (по мнению модели) компаний, лучше всего по сравнению с остальными с этим справляться CatBosting.**

